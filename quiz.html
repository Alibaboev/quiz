<!DOCTYPE html>
<html lang="ru" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI-—Ç–µ—Å—Ç –ø–æ –ø—Ä–æ—Ñ–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ | MedStudy.cz (–§–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
  <!-- 
    NOTE FOR DEVELOPER:
    This version loads content from external `questions.json` and `prompts.json` files.
    For this demo to work, these JSON files must be in the same folder as this HTML file,
    and you need to run it through a local web server (e.g., VS Code Live Server).
    Opening the HTML directly from the file system (`file://`) will block the `fetch` requests.
    In a Next.js environment, these files would be read from the file system on the server-side.
  -->
  <style>
    body{font-family:'Inter',sans-serif;background:#fff;color:#7A8899}
    .page_main{display:flex;flex-direction:column;justify-content:center;align-items:center;padding:1rem;min-height:100vh;width:100%}
    @media (min-width:701px){.page_main{padding:2rem}}
    .quiz-container{background:#fff;padding:2rem;border-radius:12px;box-shadow:0 0 30px 0 rgba(0,0,0,.07),0 30px 60px 0 rgba(0,0,0,.12);width:100%;max-width:640px;text-align:center;border:1px solid #e5e7eb}
    h1,h2{color:#153060;line-height:1.3}
    h1{font-size:28px;font-weight:700}
    h2{font-size:22px;font-weight:600}
    @media (min-width:768px){h1{font-size:42px}h2{font-size:28px}}
    .btn{padding:14px 24px;border-radius:8px;font-weight:600;transition:.2s;cursor:pointer;display:inline-block;text-align:center;border:1px solid transparent}
    .btn:disabled{background:#d1d5db;cursor:not-allowed}
    .btn-primary{background:#153060;color:#fff}
    .btn-primary:hover:not(:disabled){background:#00C0FD}
    .btn-secondary{background:transparent;color:#153060;border:2px solid #153060}
    .btn-secondary:hover{background:#153060;color:#fff}
    .loader{border:4px solid #e5e7eb;border-top:4px solid #153060;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:20px auto}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .progress-bar-container{width:100%;background:#e5e7eb;border-radius:9999px;height:8px;margin-bottom:.5rem}
    .progress-bar-inner{background:#00C0FD;height:100%;border-radius:9999px;transition:width .3s ease-in-out}
    .quiz-option{width:100%;padding:1rem;border:2px solid #e5e7eb;border-radius:8px;text-align:left;transition:.2s;font-weight:500;color:#153060}
    .quiz-option:hover,.quiz-option:focus{background:#F6F8FA;border-color:#00C0FD;outline:none}
    .form-input,.open-question-textarea{width:100%;padding:12px;border:1px solid #dcdcdc;border-radius:4px;font-size:1rem;resize:vertical}
    .form-input:focus,.open-question-textarea:focus{outline:none;border-color:#153060;box-shadow:0 0 0 2px rgba(21,48,96,.2)}
    .input-hint{font-size:0.875rem;color:#ef4444;text-align:left;margin-top:0.5rem;}
    #results-output h2,#results-output h3{font-weight:700;color:#153060;margin-top:1.5em;margin-bottom:.5em}
    #results-output h2{font-size:1.5em}
    #results-output h3{font-size:1.25em}
    #results-output p{margin-bottom:1em}
    #results-output ol,#results-output ul{list-style-position:inside;margin-left:1em;margin-bottom:1em}
    #results-output li{margin-bottom:.5em}
    #results-output b{color:#153060}
    #results-output small{color:#7A8899;font-size:.875em}
    .preview-wrap{position:relative;border:1px solid #e5e7eb;border-radius:10px;overflow:hidden;background:#f8fafc}
    .preview-content{padding:14px;filter:blur(3px)}
    .preview-wrap::after{content:"";position:absolute;left:0;right:0;bottom:0;height:56px;background:linear-gradient(to top, rgba(255,255,255,0.96), rgba(255,255,255,0))}
    .preview-label{position:absolute;bottom:8px;right:12px;font-size:12px;color:#64748b;background:#fff;padding:4px 8px;border-radius:6px;border:1px solid #e5e7eb}
  </style>
</head>
<body class="flex flex-col min-h-screen">
  <header class="bg-white">
    <div class="container mx-auto px-6 py-4 flex justify-center items-center max-w-6xl">
      <a href="#" class="text-2xl font-bold" style="color:#153060">MedStudy.cz</a>
    </div>
  </header>

  <main class="page_main">
    <div class="quiz-container">
      <div id="app-loader" class="loader"></div>
      <!-- Screen 1: Start View -->
      <div id="start-container" class="hidden">
        <h1 class="mb-4">üéØ –í—ã–±–µ—Ä–∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏—é –∏ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç –º–µ—á—Ç—ã –≤ –ß–µ—Ö–∏–∏ ‚Äî –∑–∞ 5 –º–∏–Ω—É—Ç</h1>
        <p class="mb-8">–û—Ç–≤–µ—Ç—å –Ω–∞ 3 –ø—Ä–æ—Å—Ç—ã—Ö –≤–æ–ø—Ä–æ—Å–∞ ‚Äî –∏ –ø–æ–ª—É—á–∏ –ø–æ–¥–±–æ—Ä–∫—É —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–µ–π –∏ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–¥–æ–π–¥—É—Ç –∏–º–µ–Ω–Ω–æ —Ç–µ–±–µ. –ë–æ–ª–µ–µ 1000 –∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç–æ–≤ —É–∂–µ –Ω–∞—à–ª–∏ —Å–≤–æ–π –ø—É—Ç—å —Å –Ω–∞—à–∏–º AI-—Ç–µ—Å—Ç–æ–º.</p>
        <button id="start-test-btn" class="btn btn-primary w-full sm:w-auto text-lg">–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç</button>
      </div>

      <!-- Screen 2: Role Selection View -->
      <div id="role-selection-container" class="hidden">
        <h2 class="mb-6">–ö—Ç–æ —Å–µ–π—á–∞—Å –ø—Ä–æ—Ö–æ–¥–∏—Ç —Ç–µ—Å—Ç?</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <button class="quiz-option text-center p-6" data-role="student">
            <span class="text-3xl">üéì</span>
            <span class="block mt-2 font-bold">–Ø ‚Äî —É—á–µ–Ω–∏–∫/—Å—Ç—É–¥–µ–Ω—Ç</span>
          </button>
          <button class="quiz-option text-center p-6" data-role="parent">
            <span class="text-3xl">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span>
            <span class="block mt-2 font-bold">–Ø ‚Äî —Ä–æ–¥–∏—Ç–µ–ª—å</span>
          </button>
        </div>
      </div>

      <!-- Screen 3: Education Level Selection View -->
      <div id="education-level-container" class="hidden">
        <h2 class="mb-6">–í–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ:</h2>
        <div class="grid grid-cols-1 gap-4">
          <button class="quiz-option" data-level="grade_9">9 –∫–ª–∞—Å—Å–∞</button>
          <button class="quiz-option" data-level="grade_11">11 –∫–ª–∞—Å—Å–∞</button>
          <button class="quiz-option" data-level="bachelor">–±–∞–∫–∞–ª–∞–≤—Ä–∏–∞—Ç–∞</button>
          <button class="quiz-option" data-level="undecided">–µ—â–µ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–∏–ª—Å—è</button>
        </div>
      </div>

      <!-- Screen 4: Language Selection View -->
      <div id="language-selection-container" class="hidden">
        <h2 class="mb-6">–ö–∞–∫–æ–π —è–∑—ã–∫ –æ–±—É—á–µ–Ω–∏—è –≤–∞–º –±–ª–∏–∂–µ?</h2>
        <div class="grid grid-cols-1 gap-4">
            <button class="quiz-option" data-lang="czech">–ß–µ—à—Å–∫–∏–π</button>
            <button class="quiz-option" data-lang="english">–ê–Ω–≥–ª–∏–π—Å–∫–∏–π</button>
            <button class="quiz-option" data-lang="both">–û–±–∞</button>
            <button class="quiz-option" data-lang="undecided">–ï—â–µ –Ω–µ –∑–Ω–∞—é</button>
        </div>
      </div>

      <!-- Screen 5: Quiz View -->
      <div id="quiz-container" class="hidden">
        <div class="sticky top-0 z-10 bg-white pb-2 -mt-4 pt-4">
          <div class="progress-bar-container"><div id="progress-bar" class="progress-bar-inner" style="width:0%"></div></div>
          <p id="progress-text" class="text-sm text-gray-500 mb-4"></p>
        </div>
        <div id="question-container" class="mb-6">
          <h2 id="question-text" class="text-xl sm:text-2xl font-semibold text-center mb-6"></h2>
          <div id="options-container" class="grid grid-cols-1 gap-4"></div>
        </div>
        <button id="next-question-btn" class="btn btn-primary w-full sm:w-auto hidden" disabled>–î–∞–ª–µ–µ</button>
      </div>

      <!-- Screen 6: Lead Capture View -->
      <div id="lead-capture-container" class="hidden">
        <h2 class="mb-4">–¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω!</h2>
        <p class="mb-4">–í–∞—à AI-–æ—Ç—á–µ—Ç –ø–æ—á—Ç–∏ –≥–æ—Ç–æ–≤. –ü–æ–ª—É—á–∏—Ç–µ –ø–æ–¥–±–æ—Ä–∫—É —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–µ–π –∏ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–æ–≤ –∏–º–µ–Ω–Ω–æ –¥–ª—è –≤–∞—Å.</p>
        <div class="preview-wrap mb-4 hidden" id="preview-wrap">
          <div id="results-preview" class="preview-content text-left text-gray-700"></div>
          <span class="preview-label">–ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç –ø—Ä–∏—à–ª–µ–º –Ω–∞ –ø–æ—á—Ç—É</span>
        </div>
        <form id="lead-form" class="text-left">
          <div class="mb-4">
            <label for="lead-name" class="block font-semibold mb-2 text-gray-700">–í–∞—à–µ –∏–º—è <span class="text-red-500">*</span></label>
            <input type="text" id="lead-name" class="form-input" required />
          </div>
          <div class="mb-4">
            <label for="lead-email" class="block font-semibold mb-2 text-gray-700">Email –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ <span class="text-red-500">*</span></label>
            <input type="email" id="lead-email" class="form-input" required />
          </div>
          <div class="mb-4">
            <label for="lead-phone" class="block font-semibold mb-2 text-gray-700">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
            <input type="tel" id="lead-phone" class="form-input" placeholder="+420 123 456 789" />
          </div>
          <div class="mb-6">
            <label for="lead-social" class="block font-semibold mb-2 text-gray-700">–ö–æ–Ω—Ç–∞–∫—Ç –≤ —Å–æ—Ü. —Å–µ—Ç—è—Ö (Telegram, Instagram)</label>
            <input type="text" id="lead-social" class="form-input" placeholder="@your_nickname" />
          </div>
          <button type="submit" id="submit-lead-btn" class="btn btn-primary w-full text-lg">–ü–æ–ª—É—á–∏—Ç—å –æ—Ç—á–µ—Ç</button>
          <div id="form-loader" class="loader hidden"></div>
          <p id="form-error" class="text-red-500 text-center mt-4 hidden"></p>
        </form>
      </div>

      <!-- Screen 7: Thank You View -->
      <div id="thank-you-container" class="hidden">
        <div class="text-5xl mb-4">üéâ</div>
        <h2 class="mb-4">–°–ø–∞—Å–∏–±–æ!</h2>
        <p class="mb-2">–í–∞—à–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —É–∂–µ –ª–µ—Ç—è—Ç –Ω–∞ –ø–æ—á—Ç—É! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞–ø–∫—É "–í—Ö–æ–¥—è—â–∏–µ".</p>
        <p class="font-semibold mb-4">–ê –ø–æ–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –Ω–∞—à–µ–º—É Telegram-–∫–∞–Ω–∞–ª—É, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≤–∞–∂–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ –æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏:</p>
        <a href="https://t.me/your_channel" target="_blank" class="btn btn-primary">–ü–µ—Ä–µ–π—Ç–∏ –≤ Telegram</a>
      </div>
    </div>
  </main>

  <script>
    // ==== CONFIGURATION ====
    const USE_MOCKS = true; 
    const MIN_OPEN_ANSWER_LENGTH = 8;
    const ERROR_MESSAGE = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞—à–∏–º –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏: manager@medstudy.cz';

    // ==== APP-WIDE VARIABLES FOR CONTENT ====
    let QUESTION_BANK = {};
    let PROMPTS = {};

    // ==== UI Elements ====
    const appLoader = document.getElementById('app-loader');
    const containers = {
        start: document.getElementById('start-container'),
        roleSelection: document.getElementById('role-selection-container'),
        educationLevel: document.getElementById('education-level-container'),
        languageSelection: document.getElementById('language-selection-container'),
        quiz: document.getElementById('quiz-container'),
        leadCapture: document.getElementById('lead-capture-container'),
        thankYou: document.getElementById('thank-you-container'),
    };
    const startTestBtn = document.getElementById('start-test-btn');
    const nextQuestionBtn = document.getElementById('next-question-btn');
    const leadForm = document.getElementById('lead-form');
    const formError = document.getElementById('form-error');
    const questionTextEl = document.getElementById('question-text');
    const optionsContainer = document.getElementById('options-container');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const previewWrap = document.getElementById('preview-wrap');
    const resultsPreview = document.getElementById('results-preview');

    // ==== State ====
    let userRole = '';
    let educationLevel = '';
    let languagePreference = '';
    let questions = [];
    let currentQuestionIndex = 0;
    let userAnswers = [];
    let lockClick = false;
    let careerResultsHtml = '';

    // ==== Scoring Logic ====
    const SCORE_WEIGHTS = { MED: 1, TECH: 1, HUM: 1, ECO: 1, NAT: 1 };
    let scores = { MED:0, TECH:0, HUM:0, ECO:0, NAT:0 };
    const KEYWORD_MAP = {
      MED: ['–≤—Ä–∞—á','–º–µ–¥','–ø–∞—Ü–∏–µ–Ω—Ç','–∫–ª–∏–Ω–∏–∫','—Ñ–∞—Ä–º–∞','–±–∏–æ–ª–æ–≥','–±–∏–æ','—Ö–∏–º','—É—Ö–æ–¥','–ø—Å–∏—Ö–æ–ª–æ–≥'],
      TECH: ['–ø—Ä–æ–≥—Ä–∞–º–º','–∫–æ–¥','it','–∞–π—Ç–∏','—Ä–æ–±–æ—Ç','–∏–Ω–∂–µ–Ω','—Ç–µ—Ö–Ω','–∞–ª–≥–æ—Ä–∏—Ç–º','–¥–∞–Ω–Ω—ã–µ','data','–º–∞—à–∏–Ω','–∏—Å–∫—É—Å—Å—Ç–≤'],
      HUM: ['–ø—Ä–∞–≤','—é—Ä–∏—Å—Ç','–ø–µ—Ä–µ–≤–æ–¥','—è–∑—ã–∫','–∏—Å—Ç–æ—Ä','–∫–æ–º–º—É–Ω–∏–∫–∞—Ü','–∂—É—Ä–Ω–∞–ª–∏—Å—Ç','—Å–æ—Ü–∏–æ–ª–æ–≥','–ø–µ–¥–∞–≥–æ–≥','–ø—Ä–µ–ø–æ–¥–∞–≤'],
      ECO: ['–±–∏–∑–Ω–µ—Å','–º–µ–Ω–µ–¥–∂','—Ñ–∏–Ω–∞–Ω—Å','–º–∞—Ä–∫–µ—Ç','—ç–∫–æ–Ω–æ–º','—Å—Ç–∞—Ä—Ç–∞–ø','–ø—Ä–µ–¥–ø—Ä–∏–Ω','—Ä—ã–Ω–æ–∫','–ª–æ–≥–∏—Å—Ç'],
      NAT: ['—ç–∫–æ–ª–æ–≥','–±–∏–æ–ª','–≥–µ–æ–≥—Ä–∞—Ñ','–≥–µ–æ–ª–æ–≥','—Ñ–∏–∑–∏–∫','–ª–∞–±–æ—Ä–∞—Ç–æ—Ä','–∏—Å—Å–ª–µ–¥–æ–≤','–Ω–∞—É–∫–∞','chem','physics','biology','ecology']
    };
    function resetScores(){ scores = { MED:0, TECH:0, HUM:0, ECO:0, NAT:0 }; }
    function applyTagScores(tagList){ if(!Array.isArray(tagList)) return; tagList.forEach(t => { if(SCORE_WEIGHTS[t] != null) scores[t] += SCORE_WEIGHTS[t]; }); }
    function applyKeywordScores(text){ const t=(text||'').toLowerCase(); for(const dir in KEYWORD_MAP){ if(KEYWORD_MAP[dir].some(k=>t.includes(k))) scores[dir]+=1; } }
    function getTopDirection(){ let best='TECH',v=-Infinity; for(const k in scores){ if(scores[k]>v){v=scores[k];best=k;} } return best; }

    // ==== API Layer (Mocks & Logic) ====
    async function apiGenerateReport() {
        if(USE_MOCKS){
            const topDir = getTopDirection();
            const topDirLabel = PROMPTS.DIR_LABELS[topDir] || '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ';
            
            // This logic will be on the backend. It constructs the prompt for the AI.
            const promptConfigKey = userRole === 'parent' ? 'parent' : `${userRole}_${educationLevel}`;
            const promptConfig = PROMPTS.reportGeneration[promptConfigKey] || PROMPTS.reportGeneration.student_grade_11; // Fallback
            const openAnswersText = userAnswers
                .filter(a => a.type === 'open-ended')
                .map(a => `Q: ${a.question}\nA: ${a.answer}`)
                .join('\n');

            let prompt = `${PROMPTS.reportGeneration.common.persona} ${promptConfig.context} ${promptConfig.task} ${promptConfig.personalization} ${promptConfig.structure} ${promptConfig.knowledgeBase} ${PROMPTS.reportGeneration.common.cta}`;
            prompt = prompt.replace(/{userRole}/g, userRole)
                           .replace(/{educationLevel}/g, educationLevel)
                           .replace(/{languagePreference}/g, languagePreference)
                           .replace(/{topDirection}/g, topDirLabel)
                           .replace(/{openAnswers}/g, openAnswersText);
            
            console.log("GENERATING REPORT WITH PROMPT:", prompt);
            await new Promise(r => setTimeout(r, 800));
            // This is a mock response. The real one will come from a Gemini API call using the prompt above.
            return `
                <h2>–í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç</h2>
                <p>–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–≤ –≤–∞—à–∏ –æ—Ç–≤–µ—Ç—ã, –º—ã –æ–ø—Ä–µ–¥–µ–ª–∏–ª–∏, —á—Ç–æ –≤–∞–º –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –ø–æ–¥—Ö–æ–¥–∏—Ç <b>${topDirLabel} –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</b>.</p>
                <h3>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h3>
                <p>–ù–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤, AI —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞...</p>
                <br>
                <a href="#" class="btn btn-primary" style="display:block; text-align:center; margin-bottom:1rem;">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é</a>
                <a href="#" class="btn btn-secondary" style="display:block; text-align:center;">–ü–æ–ª—É—á–∏—Ç—å –≥–∞–π–¥ –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é</a>
            `;
        }
        // Real implementation would fetch from '/api/generate-report'
    }

    async function apiSubmitLead(payload){
        if(USE_MOCKS){
            console.log("MOCK SUBMIT:", payload);
            await new Promise(r => setTimeout(r, 600));
            return { ok: true, leadId: 'DEMO-' + Date.now() };
        }
        // Real implementation would fetch from '/api/submit-lead'
    }
    
    // ==== DataLayer for Analytics ====
    function pushToDataLayer(event, payload = {}) {
        if (typeof window.dataLayer !== 'undefined') {
            window.dataLayer.push({ event, ...payload });
        }
    }

    // ==== Flow Control Functions ====
    function showScreen(screenName) {
        appLoader.classList.add('hidden');
        Object.values(containers).forEach(c => c.classList.add('hidden'));
        if (containers[screenName]) {
            containers[screenName].classList.remove('hidden');
        }
    }

    function startQuizFlow() {
        resetScores();
        questions = (userRole === 'parent') 
            ? QUESTION_BANK.parent.all 
            : (QUESTION_BANK.student[educationLevel] || QUESTION_BANK.student.undecided);
        currentQuestionIndex = 0;
        userAnswers = [];
        progressBar.style.width = '0%';
        showScreen('quiz');
        displayQuestion();
    }

    function displayQuestion(){
        if(currentQuestionIndex < questions.length){
            const q = questions[currentQuestionIndex];
            questionTextEl.textContent = q.question;
            optionsContainer.innerHTML='';
            nextQuestionBtn.classList.add('hidden');
            if(q.type==='multiple-choice'){
                q.options.forEach((option, idx)=>{
                    const b=document.createElement('button');
                    b.textContent=option; b.className='quiz-option';
                    const tag = (q.tags && q.tags[idx]) || [];
                    b.onclick=()=> selectAnswer(q, option, tag);
                    optionsContainer.appendChild(b);
                });
            } else { // open-ended
                const ta = document.createElement('textarea');
                const hint = document.createElement('p');
                hint.className = 'input-hint hidden';
                ta.className='open-question-textarea'; ta.rows=4; ta.maxLength=240; ta.placeholder='–í–∞—à –æ—Ç–≤–µ—Ç...';
                ta.addEventListener('input',()=>{ const isLongEnough = ta.value.trim().length >= MIN_OPEN_ANSWER_LENGTH; nextQuestionBtn.disabled = !isLongEnough; hint.classList.toggle('hidden', isLongEnough); });
                hint.textContent = `–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–∞–π—Ç–µ –±–æ–ª–µ–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π –æ—Ç–≤–µ—Ç (–º–∏–Ω. ${MIN_OPEN_ANSWER_LENGTH} —Å–∏–º–≤–æ–ª–æ–≤).`;
                optionsContainer.appendChild(ta); optionsContainer.appendChild(hint);
                nextQuestionBtn.classList.remove('hidden'); nextQuestionBtn.disabled = true;
            }
            progressText.textContent = `–í–æ–ø—Ä–æ—Å ${currentQuestionIndex + 1} –∏–∑ ${questions.length}`;
            const progress = ((currentQuestionIndex) / questions.length) * 100;
            progressBar.style.width = `${progress}%`;
        } else {
            progressBar.style.width='100%';
            finishQuiz();
        }
    }
    
    function handleNextQuestion(){
        const ta = optionsContainer.querySelector('textarea');
        if(ta && ta.value.trim().length >= MIN_OPEN_ANSWER_LENGTH){
            selectAnswer(questions[currentQuestionIndex], ta.value.trim(), []);
        }
    }
    
    function selectAnswer(qObj, answer, tags){
        if(lockClick) return;
        lockClick = true;
        if(qObj.type === 'multiple-choice'){ applyTagScores(tags); } 
        else { applyKeywordScores(answer); }
        userAnswers.push({ question: qObj.question, answer: answer, type: qObj.type });
        
        pushToDataLayer('quiz_step_complete', {
            step_number: currentQuestionIndex + 1,
            question_text: qObj.question
        });
        
        currentQuestionIndex++;
        setTimeout(()=>{ lockClick=false; displayQuestion(); }, 150);
    }
    
    async function finishQuiz(){
        showScreen('leadCapture');
        pushToDataLayer('quiz_complete');
        try {
            const html = await apiGenerateReport();
            careerResultsHtml = html || '';
            const clean = DOMPurify.sanitize(careerResultsHtml, {USE_PROFILES:{html:true}});
            if(clean){ resultsPreview.innerHTML = clean; previewWrap.classList.remove('hidden'); }
        } catch(err) { 
            console.error("Report generation failed:", err); 
            pushToDataLayer('generate_report_error', { error_message: err.message });
        }
    }
    
    async function handleFormSubmit(e){
        e.preventDefault();
        const submitBtn = document.getElementById('submit-lead-btn');
        const formLoader = document.getElementById('form-loader');
        submitBtn.classList.add('hidden'); formLoader.classList.remove('hidden'); formError.classList.add('hidden');
        
        const topDirection = getTopDirection();
        const payload = {
            name: document.getElementById('lead-name').value.trim(),
            email: document.getElementById('lead-email').value.trim(),
            phone: document.getElementById('lead-phone').value.trim(),
            social: document.getElementById('lead-social').value.trim(),
            userRole, educationLevel, languagePreference, scores,
            openAnswers: userAnswers.filter(a => a.type === 'open-ended'),
            testResults: careerResultsHtml,
        };
        
        pushToDataLayer('lead_submit', {
            user_role: userRole,
            education_level: educationLevel,
            top_direction: topDirection
        });
        
        try {
            await apiSubmitLead(payload);
            showScreen('thankYou');
        } catch(err) {
            console.error(err);
            formError.textContent = ERROR_MESSAGE;
            formError.classList.remove('hidden');
            submitBtn.classList.remove('hidden');
            formLoader.classList.add('hidden');
        }
    }

    // ==== App Initialization ====
    async function main() {
        try {
            // Load content from external files
            const [questionsRes, promptsRes] = await Promise.all([
                fetch('./questions.json'),
                fetch('./prompts.json')
            ]);
            if (!questionsRes.ok || !promptsRes.ok) {
                throw new Error('Failed to load content files.');
            }
            QUESTION_BANK = await questionsRes.json();
            PROMPTS = await promptsRes.json();
            
            showScreen('start');

            // Setup event listeners
            startTestBtn.addEventListener('click', () => {
                showScreen('roleSelection');
                pushToDataLayer('quiz_start', { user_role: 'unknown', education_level: 'unknown' });
            });
            containers.roleSelection.addEventListener('click', (e) => {
                const role = e.target.closest('button')?.dataset.role;
                if (role) { userRole = role; showScreen('educationLevel'); }
            });
            containers.educationLevel.addEventListener('click', (e) => {
                const level = e.target.closest('button')?.dataset.level;
                if (level) { educationLevel = level; showScreen('languageSelection'); }
            });
            containers.languageSelection.addEventListener('click', (e) => {
                const lang = e.target.closest('button')?.dataset.lang;
                if (lang) { languagePreference = lang; startQuizFlow(); }
            });
            nextQuestionBtn.addEventListener('click', handleNextQuestion);
            leadForm.addEventListener('submit', handleFormSubmit);

        } catch (error) {
            console.error("Initialization failed:", error);
            appLoader.parentElement.innerHTML = `<p class="text-red-500">${ERROR_MESSAGE}</p>`;
        }
    }

    main();
  </script>
</body>
</html>
